name: CI/CD Pipeline

on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    name: Build & Deploy CampusConnect
    runs-on: ubuntu-latest

    env:
      ACR_NAME: campusconnectacr
      RESOURCE_GROUP: cc-resource-group
      CLUSTER_NAME: CampusConnectAKS
      IMAGE_TAG: ${{ github.sha }}

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Log in to Azure
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Set AKS context
      uses: azure/aks-set-context@v3
      with:
        resource-group: ${{ env.RESOURCE_GROUP }}
        cluster-name: ${{ env.CLUSTER_NAME }}

    - name: Log in to ACR
      run: az acr login --name $ACR_NAME

    - name: Build and Push Backend Image
      run: |
        docker build -t $ACR_NAME.azurecr.io/campusconnect-backend:${{ env.IMAGE_TAG }} ./backend
        docker push $ACR_NAME.azurecr.io/campusconnect-backend:${{ env.IMAGE_TAG }}

    - name: Build and Push Frontend Image
      run: |
        docker build -t $ACR_NAME.azurecr.io/campusconnect-frontend:${{ env.IMAGE_TAG }} ./frontend
        docker push $ACR_NAME.azurecr.io/campusconnect-frontend:${{ env.IMAGE_TAG }}

    - name: Update Backend Deployment in AKS
      run: |
        kubectl set image deployment/backend backend=$ACR_NAME.azurecr.io/campusconnect-backend:${{ env.IMAGE_TAG }} -n campusconnect

    - name: Update Frontend Deployment in AKS
      run: |
        kubectl set image deployment/frontend frontend=$ACR_NAME.azurecr.io/campusconnect-frontend:${{ env.IMAGE_TAG }} -n campusconnect

    # Optional Health Check
    - name: Check API Health
      run: curl --fail --silent https://sait.campusconnect.it.com/api/ || exit 1
